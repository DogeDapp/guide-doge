#!/usr/bin/env node

const path = require('path');
const fs = require('fs');
const request = require('request');

const countriesInputUrl = 'https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.json';
const citiesInputPath = path.resolve(__dirname, 'simplemaps_worldcities_basicv1.6', 'worldcities.csv');
const outputPath = path.resolve(__dirname, '..', 'src', 'assets', 'world.json');

request(countriesInputUrl, { json: true }, (err, res, body) => {
  if (err) {
    throw err;
  }

  const world = { continents: {} };
  const iso2ToCountries = {};

  // initiate the mappings
  body.forEach(rawCountry => {
    const {
      'country-code': countryId,
      'alpha-2': countryIso2,
      'name': countryName,
      'sub-region-code': subcontinentId,
      'sub-region': subcontinentName,
      'region-code': continentId,
      'region': continentName,
    } = rawCountry;

    const continent = world.continents[continentId] = {
      name: continentName,
      subcontinents: {},
      ...(world.continents[continentId] || {}),
    };

    const subcontinent = continent.subcontinents[subcontinentId] = {
      name: subcontinentName,
      countries: {},
      ...(continent.subcontinents[subcontinentId] || {}),
    };

    const country = subcontinent.countries[countryId] = {
      name: countryName,
      cities: {},
    };

    iso2ToCountries[countryIso2] = country;
  });

  const citiesCsv = fs.readFileSync(citiesInputPath, 'utf8');
  csv2json(citiesCsv)
    .filter(city => city.population > 100_000)
    .forEach(city => {
      const country = iso2ToCountries[city.iso2];
      country.cities[city.id] = {
        name: city.city_ascii,
        lat: +city.lat,
        lng: +city.lng,
        population: +city.population,
      };
    });

  // write json
  const content = {
    world,
  };
  fs.writeFileSync(outputPath, JSON.stringify(content), 'utf8');
});

// convert csv to json
function csv2json(csv) {
  const [headerRow, ...rows] = csv
    .split('\r\n')
    .map(v => {
        const matches = [...v.matchAll(/"([^"]*)"/g)];
        return matches.map(match => match[1]);
      },
    );
  return rows
    .map(values => {
      const dictionary = {};
      headerRow.forEach((label, i) => {
        dictionary[label] = values[i];
      });
      return dictionary;
    });
}
